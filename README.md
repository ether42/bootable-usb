Some simple scripts left here as a reminder on how to create a bootable live USB key for both
BIOS and UEFI.

---

### Debian Live boot ISO

To create a custom Debian Live ISO (could later be made bootable):
```shell
mkdir workdir && mount none -t tmpfs workdir # optional, could speed up ISO creation
[PASSWORD=root] ./debian_live_custom_iso.bash workdir
```
 - `PASSWORD` is the root password.

For customizing the ISO creation, you could:
 - modify installed packages by editing
   [`debian_live_custom_iso/packages.txt`](debian_live_custom_iso/packages.txt).
 - modify the chroot by editing
   [`debian_live_custom_iso/customize_chroot.bash`](debian_live_custom_iso/customize_chroot.bash)
   or exporting a Bash function named `customize_chroot`.

---

### Bootable USB key

To make a bootable USB:
```shell
[PASSWORD=root] [SIZE=1024] ./bootable_usb.bash /dev/sdX [workdir/debian_live_custom.iso]
```
 - `PASSWORD` unlocking password of the LUKS partition used for the USB key contents
    verification from the GRUB menu (see below).
 - `SIZE` is the size of the EFI partition, in MiB.

By providing the path to the ISO generated by `debian_live_custom_iso.bash` as a second argument,
you could boot a Debian Live system with or without Xen.

For customizing the bootable USB key creation, simply add or remove `.bash` files in
[`bootable_usb/hooks`](bootable_usb/hooks).

---

### Overview

#### USB key

The USB key is formatted as a GPT disk:

|  Partition  | Size
|:-----------:|:-----
| GRUB        | 1MiB
| CHECKSUM    | 4MiB
| EFI         | `SIZE`MiB

Note that the first partition is aligned to 1MiB for performance reasons.

 - `GRUB`: partition used by GRUB for storing its stage 1.5, necessary to boot on non-EFI hardware.
 - `CHECKSUM`: LUKS partition added to verify the USB's key integrity, contains a checksum of every
   file that was stored in the EFI partition at build time. For paranoid people like me.
 - `EFI`: FAT partition, stores everything from GRUB's configuration and modules to EFI applications
   and bootable images.

There is also an Intel's BIOS-flasing utility installed (you may need to provided the BIOS images),
accessible through an EFI shell.

#### GRUB

By default, GRUB will show the following menu:
```
  ┌ Verify USB contents
  ├ Debian Live (custom)
  │  ├ Debian Live (custom)
  │  ├ Xen - Debian Live (custom)
  │  └ Debian Live (custom) - no persistence
  └ EFI shell
    ├ EFI shell - IA32
    └ EFI shell - X64
```

 - `Verify USB contents`: check the USB key integrity by entering the choosen password for the
   LUKS partition (else it would be too easy to modify the USB key contents and recreate a checksum
   file).
 - `Debian Live (custom)`: boot the Debian Live previously created.
 - `Xen - Debian Live (custom)`: boot the Debian Live previously created as a Xen Dom0.
 - `Debian Live (custom) - no persistence`: boot the Debian Live previously created, with the
   [`nopersistence`][debian live boot options] option (good for a fresh start or a strictly live
   boot).
 - `EFI shell - IA32` if you booted under a 32-bit EFI, starts a shell.
 - `EFI shell - X64` if you booted under a 64-bit EFI, starts a shell.

#### Persistence

Here is how to create an encrypted [persistence partition][debian live persistence description]
on a disk (you could do this directly from the Debian Live you booted from the USB key):
```shell
parted --script /dev/sdX mklabel gpt
parted --script --align=optimal /dev/sdX mkpart encrypted-persistence 1MiB 8193MiB # 8GiB
cryptsetup luksFormat /dev/sdX1 # you may want to add the --cipher option, see cryptsetup benchmark
cryptsetup luksOpen /dev/sdX1 encryped-persistence
mkfs.ext4 -L persisence /dev/mapper/encrypted-persistence
mount /dev/mapper/encrypted-persistence /mnt
echo '/ union' > /mnt/persistence.conf # you may want to refine this
umount /mnt
cryptsetup luksClose encrypted-persistence
reboot # for applying modifications, persistence.conf is read by scripts from the initramfs
```

If you aren't concerned by encryption, remove the cryptsetup-related operations.

Notes:
 - it's safe to remove the USB key once booted due to the [`toram`][debian live boot options]
   option.
 - [multiple persistences][debian live multiple persistences] may be configured.

There are some small caveats:
 - during boot, the live init script will ask a password for each LUKS partition found,
   including the one the USB key, which you may safely ignore.
 - you may not have an encrypted persistence partition on an LVM volume (not supported by the
   live scripts).

#### Encryption notes

Instead of the `CHECKSUM` partition, the [`encryption`][debian live boot options] option could have
been used if the support wasn't removed from recent `losetup`. It would have forced the management
of kernels and initrds outside of the ISO, which may have been cumbersome (as GRUB does not seem to
support encrypted loopbacks).

The difficulty in fully encrypted live non-toy OS images results in the fact that both the
bootloader and the OS have to support it.

It is possible to boot an encrypted root filesystem hosting the kernel and its initrd by first
opening it in GRUB and then reopening it at boot time (the key may have been lost between the two).
This option is sensible for a non-USB boot but is difficult without first-class OS support for live
images on an USB key (this could be achieved by adding scripts into the initramfs for one's
particular needs but the primary goal was to get an easily maintainable system).

The `CHECKSUM` alternative seems good enough as only important information should be stored in
(encrypted) `persistence` partitions.

---

More links:
 - [GRUB manual]
 - [Debian Live manual]
 - [Cryptsetup FAQ]

[grub manual]: https://www.gnu.org/software/grub/manual/grub.html
[debian live manual]: https://debian-live.alioth.debian.org/live-manual/stable/manual/html/live-manual.en.html
[cryptsetup faq]: https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions
[debian live boot options]: https://manpages.debian.org/jessie/live-boot-doc/live-boot.7.en.html#OPTIONS
[debian live persistence description]: https://debian-live.alioth.debian.org/live-manual/stable/manual/html/live-manual.en.html#556
[debian live multiple persistences]: https://debian-live.alioth.debian.org/live-manual/stable/manual/html/live-manual.en.html#583
